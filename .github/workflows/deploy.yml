name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # üõ†Ô∏è –°–±–æ—Ä–∫–∞, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –ª–∏–Ω—Ç–∏–Ω–≥ –∏ —Ç–µ—Å—Ç—ã
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ –°–∫–∞—á–∏–≤–∞–µ–º –∫–æ–¥
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–µ—Ä–∞ (flake8)
      - name: Lint with flake8
        run: |
          pip install flake8
          flake8 . || true   # —á—Ç–æ–±—ã workflow –Ω–µ –ø–∞–¥–∞–ª –∏–∑-–∑–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π

      # 5Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PYTHONPATH –∏ –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      - name: Run tests with pytest
        run: |
          pip install pytest
          PYTHONPATH=$GITHUB_WORKSPACE pytest -q

  # üê≥ Docker job ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ build –ø—Ä–æ—à—ë–ª
  docker:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build Docker image
        run: |
          docker build -t u-money-calculator .

      - name: Run Docker container
        run: |
          docker run --rm u-money-calculator
